
---
output: 
  html_document:
  pdf_document: default
  word_document: default
title: "Fall 2020 - Math 421 - Midterm"
---

-------

# Instruction

The midterm has two components: the Rmarkdown notebook (html) and the presentation.  The notebook and the presentation file are due Nov 26. We will do the presentation in class 

**The notebook:** The notebook should be created using `rmarkdown` (like other assignments). The notebook should have a title. 


**The Presentation:** Present your results in 5-10 minutes. To make the presentation using Rmarkdown, do the follows: 

    - In Rstudio -> File -> New File -> R markdown
    
    - In the left panel, click to Presentation -> Click OK
    
    - Now you have an Rmarkdown that can be knitted to be a html presentation 
    

**Data:**  The data for the mid-term project is the Rhode Island Department of Health Hospital Discharge Data.  Each row of the data presents a patient. 

Link: https://drive.google.com/open?id=15QNBf6YYKocK2nNIfpKDer58kQnCPNZJ 

-------

## I. Data Wrangling

1. Download the data file `hdd0318cy.sas7bdat`.  

2. Use `read_sas` in library `haven` to read the data. 

```{r}
library(haven)

midterm_df <- read_sas('hdd0318cy.sas7bdat')

```

```{r}
head(midterm_df)
```

    
3. Filter the data to have only patients of the year 2018 (`yod==2018`)

```{r}
library(dplyr)

midterm_2018 <- filter(midterm_df,yod==18)
```

    
4. Select to work with only following variables: 

```{r}
midterm_df_final <- midterm_2018 %>% select(
                      "yod", "payfix","pay_ub92","age",  
                      "sex","raceethn","provider","moa", 
                      "yoa","mod","admtype", "asource" , 
                      "preopday" ,"los", "service" , "icu","ccu",    
                      "dispub92", "payer"  ,"drg","trandb", 
                      "randbg","randbs","orr", "anes","seq",   
                      "lab","dtest", "ther","blood","phar", 
                      "other","patcon","bwght","total","tot" ,  
                      "ecodub92","b_wt","pt_state","diag_adm","ancilar" ,
                      "campus","er_fee","er_chrg","er_mode","obs_chrg",
                      "obs_hour","psycchrg","nicu_day" )
head(midterm_df_final)
```
 

*Notice*:  You may want to save the current data on your laptop if you want to read it again.  To save the data file use `write_csv(df, 'midterm.csv')`, for example.  

```{r}
#write_csv(midterm_df_final,'midterm.csv')
```


5. What are variables that have missing values?

```{r}
library(tidyverse)

colSums(is.na(midterm_df_final))
```

 
6. Remove all variables with missing values

```{r}
midterm_df_final$payfix <- NULL
midterm_df_final$preopday <- NULL
midterm_df_final$obs_hour <- NULL
midterm_df_final$nicu_day <- NULL
```


 
7. Refer to the data description in the file `HDD2015-18cy6-20-19.docx`, which variable recording the month of admission?, which variable recording the month of discharge?

moa = month of admission
mod= month of discharge


8. Which month admitted the most number of patients? Which month admitted the most number of male patients?

```{r}
midterm_df_final %>%
  group_by(moa) %>% 
  count()
```
```{r}
midterm_df_final %>%
  filter(sex==1) %>% 
  group_by(moa) %>% 
  count()
```


9. Which month has the most number of teenage female patients?
```{r}
midterm_df_final %>%
  filter(sex==2,age>=13,age<20) %>%
  group_by(moa) %>% 
  count()
```


10. Which provider has the most number of female patients in October?

```{r}
midterm_df_final %>%
  filter(sex==2,age>=13,age<20,moa==10) %>%
  group_by(provider) %>% 
  count()
```


11. Is female patients older than male patients, on average? 

```{r}
midterm_df_final %>%
  filter(sex==1) %>%
  summarise(mean(age))
```
```{r}
midterm_df_final %>%
  filter(sex==2) %>%
  summarise(mean(age))
```


12. Calculate the average age of patients by months. Which month has the oldest patients on average age?
```{r}
midterm_df_final %>%
  filter(sex==1) %>%
  group_by(moa) %>% 
  summarise(mean(age))
```


13. What is the name of the provider that has the highest total charge?
```{r}
midterm_df_final$total <- as.numeric(midterm_df_final$total)
midterm_df_final %>%
  group_by(provider) %>% 
  summarise(mean(total))
```

14. What is the name of the provider that has the least total charge for teenage male?
```{r}
midterm_df_final %>%
  filter(sex==1,age>=13,age<20) %>%
  group_by(provider) %>% 
  summarise(min(total))
```


15. Calculate the length of stays by races.  Which race has the longest length of stays on average?
```{r}
midterm_df_final %>%
  group_by(raceethn) %>% 
  summarise(mean(los))
```

16. On average, how much a 20 year-old male white get charged for staying 1 day?

```{r}
midterm_df_final %>%
  filter(sex==1,age==20,los==1,raceethn==1) %>%
  summarise(mean(total))
```


-------

## II. Data Visualization

Continue with the data from part I. 

1. Provides at least 10 meaningful plots. Comments on the plots. All plots should have title, caption, appropriate labels on x and y-axis
```{r}
#plot 1
los_plot <- midterm_df_final %>%
  group_by(raceethn) %>% 
  summarise(meanlos=mean(los))
ggplot(los_plot, aes(x=raceethn, y=meanlos)) + geom_col() + ggtitle("Length of Stay by Race") + labs(y="Mean Length of Stay", x = "Race", caption = "A plot of average length of stay by race.From the plot you can see Unknown race (9) has the highest average length of stay.") + theme_minimal()
```


```{r}
#plot 2
age_plot <- midterm_df_final %>%
  group_by(sex) %>% 
  summarise(meanage=mean(age))
ggplot(age_plot, aes(x=sex, y=meanage)) + geom_col() + ggtitle("Mean Age by Sex") + labs(y="Mean Age", x = "Sex", caption = "A plot of average age by sex, the female admitted patients have a lower age than the male patients") 
```

```{r}
#plot 3
ggplot(midterm_df_final, aes(x=age, y=los,color=raceethn)) + geom_jitter() + ggtitle("Age vs Length of Stay by Race") + labs(y="Length of Stay", x = "Age", caption = "Age and length of stay colored by race/ethnicity. Seems that babies (age 0) have a high concentration of longer stays") 
```
```{r}
#plot 4

ggplot(midterm_df_final, aes(x=moa)) + geom_bar() + ggtitle("Total Admissions by Month ") + labs(y="Total Admissions", x = "Month", caption = "A plot of total admissons by month, January has the highest total where the next month of Feburary has the lowest.") 
```

```{r}
#plot 5
midterm_df_final$total <- as.numeric(midterm_df_final$total)
ggplot(midterm_df_final, aes(x=moa, y=total, color=sex)) + geom_col() + ggtitle("Total Charges by Month of Admission ") + labs(y="Total Charge", x = "Month", caption = "A plot of total charges by month and colored by sex")
```
```{r}
#plot 6
ggplot(midterm_df_final, aes(age)) + geom_density() + ggtitle("Density plot of age") + labs(y="Density", x = "Age", caption = "Density plot of the age variable. There are three distinct peaks, one for babies, 30-35 year olds, and elderly people")
```
```{r}
#plot 7

ggplot(midterm_df_final, aes(x=provider, y=total)) + geom_col() + ggtitle("Total Charges by Provider ") + labs(y="Total Charge", x = "Provider", caption = "The highest peak is Rhode Island Hospital, this makes sense because they are the largest hospital in Rhode Island and they do more complicated procedures")
```
```{r}
midterm_df_final$b_wt <- as.numeric(midterm_df_final$b_wt)
```



```{r}
#plot 8

ggplot(midterm_df_final, aes(x=b_wt, y=total, color=sex)) + geom_jitter() + ggtitle("Total Charges by Baby's Birthweight") + labs(y="Total Charge", x = "bwght", caption = "The lower the baby's birthweight, the higher the charges")
```
```{r}
midterm_df_final$age_bins <- case_when(
  midterm_df_final$age <=13 ~ 'child',
  midterm_df_final$age <20 ~ 'teen',
  midterm_df_final$age <40 ~  'young adult',
  midterm_df_final$age <=64 ~ 'middle',
  TRUE ~ 'elderly')
```

```{r}
#plot 9

ggplot(midterm_df_final, aes(x=payer, y=total, color=age_bins)) + geom_col() + ggtitle("Total Charges by Payer") + labs(y="Total Charge", x = "Payer Code", caption = "Medicare is the highest payment, especially in the elderly age range.")
```

```{r}
#plot 10
`%notin%` <- Negate(`%in%`)
er_mode <- midterm_df_final %>% filter(er_mode %notin% c(0,9))
ggplot(er_mode, aes(x=er_mode,color=age_bins)) + geom_bar() + ggtitle("ER Mode of Arrival by Age") + labs(y="ER admits", x = "ER mode of arrival", caption = "Filtered out for NA and Unknown, the highest was through an ambulance or personal transportation") + theme_classic()
```

2. Make an animation
```{r}
d1 <- midterm_df_final %>%
  group_by(moa,raceethn) %>% 
  count()
d2 <- d1 %>% mutate(rank=rank(-n)) %>% ungroup()
```


```{r}
library(gganimate)

a1 <- d2 %>% 
  ggplot(aes(y=n,
            x=moa,
            color=raceethn))+ 
  geom_line()+
  geom_point(size=3)+
  geom_text(aes(label = n), 
            hjust = -.1, size=5) +
  transition_reveal(moa)
animate(a1,nframes = 150)
```


-------

## III. Predictive Models

Continue with the data from part I. Use the follows as the target and input variables: 

*Target Variable*: Create the target variable taking value of 

  - `low cost` if the total charge of a patient (`tot`) is smaller than the median of the total charge, and

  - `high cost` otherwise. 

*Input Variables*:

  - "age","sex","raceethn","provider","moa","mod","admtype","campus", "er_mode", 'los'
  
-------
```{r}
midterm_df_model <- midterm_df_final %>% 
  select("age","sex","raceethn","provider","moa","mod","admtype","campus", "er_mode", 'los','total')
head(midterm_df_model)
```

```{r}
midterm_df_model$total <- as.numeric(midterm_df_model$total)
median(midterm_df_model$total)
```


```{r}
midterm_df_model$target <- case_when(
  midterm_df_model$total <=21854 ~ 'low cost',
  TRUE ~ 'high cost')
midterm_df_model$total <- NULL
head(midterm_df_model)
```


1. Make sure all the categorical variables are factor, numeric variables are numeric. Set Training : Testing Split = 10 : 90 

```{r}
midterm_df_model$raceethn <- factor(midterm_df_model$raceethn)
midterm_df_model$provider <- factor(midterm_df_model$provider)
midterm_df_model$moa <- factor(midterm_df_model$moa)
midterm_df_model$mod <- factor(midterm_df_model$mod)
midterm_df_model$admtype <- factor(midterm_df_model$admtype)
midterm_df_model$campus <- factor(midterm_df_model$campus)
midterm_df_model$er_mode <- factor(midterm_df_model$er_mode)
```

```{r}

library(caret)

set.seed(2020)

splitIndex <- createDataPartition(midterm_df_model$target, p = .10, 
                                  list = FALSE)
df_train <- midterm_df_model[ splitIndex,]
df_test <- midterm_df_model[-splitIndex,]

```


2. Train a decision tree using `rpart`.  Plot the decision tree. Plot the variable importance ranked by the tree. 
```{r}
library(rpart) 

tree_model <- rpart(target ~ ., data = df_train,
                 control = rpart.control(maxdepth = 3))

```

```{r}
library(rattle)
fancyRpartPlot(tree_model)
```


3. Using caret for this question. Set `Training Control` to be: Use Cross-Validation of 5 folds across all models.  Train & tune at least 3 different models (i.e. three different values for `method=` in the train function of caret).  Plot the hyper-parameter tuning plots for each model. 
```{r}
tuneGrid = expand.grid(mtry = 2:4)


trControl = trainControl(method = "cv",
                         number = 5)

forest_cv <- train(target~., data=df_train, 
                                method = "rf", 
                                trControl = trControl,
                                tuneGrid = tuneGrid)
```

```{r}
plot(forest_cv)
```

```{r}
trControl = trainControl(method = "cv",
                         number = 5)
tuneGrid = expand.grid(mtry=2:4)
parRF_cv <- train(target~., data=df_train, 
                    method = "parRF", 
                    trControl = trControl,
                    tuneGrid = tuneGrid)
```

```{r}
plot(parRF_cv)
```


```{r}
tuneGrid = expand.grid(mtry = 2:4)


trControl = trainControl(method = "cv",
                         number = 5)

cforest_cv <- train(target~., data=df_train, 
                                method = "cforest", 
                                trControl = trControl,
                                tuneGrid = tuneGrid)
```

```{r}
plot(cforest_cv)
```



4. Plot the comparison of the models in 2. 

```{r}
results <- resamples(list(forest = forest_cv,
                          parRF = parRF_cv,
                          cforest = cforest_cv))
bwplot(results)
```


5. What is your final selection for the model? Test the accuracy of your final model on the test data. 
```{r}
pred <- predict(cforest_cv, df_test)
cm <- confusionMatrix(data = pred, reference = df_test$target, positive = "high cost")
cm$overall[1]
```

6. Create another `target` variable (binary), decide the input variables and redo 1 to 5. 

```{r}
midterm_df_model2 <- midterm_df_final %>% 
  select("age", "sex","raceethn","provider", "admtype", 
          "los", "service" , "payer","total","campus","er_mode")
midterm_df_model2$target <- case_when(
  midterm_df_model2$age <65 ~ 'young',
  TRUE ~ 'old')
midterm_df_model2$age <- NULL
```

```{r}
set.seed(2020)

splitIndex <- createDataPartition(midterm_df_model2$target, p = .10, 
                                  list = FALSE)
df_train2 <- midterm_df_model2[ splitIndex,]
df_test2 <- midterm_df_model2[-splitIndex,]

```

```{r}
tuneGrid = expand.grid(mtry = 2:4)


trControl = trainControl(method = "cv",
                         number = 5)

forest_cv2 <- train(target~., data=df_train2, 
                                method = "rf", 
                                trControl = trControl,
                                tuneGrid = tuneGrid)
```

```{r}
plot(forest_cv2)
```


```{r}
trControl = trainControl(method = "cv",
                         number = 5)
tuneGrid = expand.grid(mtry=2:4)
parRF_cv2 <- train(target~., data=df_train2, 
                    method = "parRF", 
                    trControl = trControl,
                    tuneGrid = tuneGrid)
```

```{r}
plot(parRF_cv2)
```


```{r}
tuneGrid = expand.grid(mtry = 2:4)


trControl = trainControl(method = "cv",
                         number = 50)

cforest_cv2 <- train(target~., data=df_train2, 
                                method = "cforest", 
                                trControl = trControl,
                                tuneGrid = tuneGrid)
```

```{r}
plot(cforest_cv2)
```

```{r}
results <- resamples(list(forest = forest_cv2,
                          parRF = parRF_cv2,
                          cforest = cforest_cv2))
bwplot(results)
```

```{r}
pred <- predict(cforest_cv, df_test)
cm <- confusionMatrix(data = pred, reference = df_test$target, positive = "old")
cm$overall[1]
```

-------